<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copy-Paste Order Input - Shipping Automation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .parsing-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .confidence-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .input-area {
            min-height: 200px;
            font-family: monospace;
        }
        .example-input {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-paste"></i> Copy-Paste Order Input</h3>
                        <p class="mb-0 text-muted">Paste customer order details and let our system parse them automatically</p>
                    </div>
                    <div class="card-body">
                        <!-- Example Format -->
                        <div class="example-input">
                            <strong>Example Input Format:</strong><br>
                            John Smith<br>
                            john.smith@email.com<br>
                            (555) 123-4567<br>
                            123 Main Street<br>
                            Las Vegas, NV 89101<br>
                            FEDEX
                        </div>

                        <form method="POST" id="orderForm">
                            <div class="mb-3">
                                <label for="order_input" class="form-label">
                                    <strong>Paste Customer Order Details:</strong>
                                </label>
                                <textarea 
                                    class="form-control input-area" 
                                    id="order_input" 
                                    name="order_input" 
                                    placeholder="Paste customer information here (name, email, phone, address, carrier preference)..."
                                    required>{{ raw_input or '' }}</textarea>
                            </div>

                            <!-- Real-time parsing preview -->
                            <div id="parsing-preview" class="parsing-preview" style="display: none;">
                                <h6>Parsing Preview <span id="confidence-badge" class="badge confidence-badge"></span></h6>
                                <div id="parsed-data"></div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary" onclick="clearInput()">
                                    Clear
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-arrow-right"></i> Parse & Continue
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Parsing Instructions</h5>
                    </div>
                    <div class="card-body">
                        <h6>Supported Formats:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> Names (John Smith)</li>
                            <li><i class="fas fa-check text-success"></i> Emails (john@email.com)</li>
                            <li><i class="fas fa-check text-success"></i> Phone numbers</li>
                            <li><i class="fas fa-check text-success"></i> Addresses</li>
                            <li><i class="fas fa-check text-success"></i> State codes (NV, CA)</li>
                            <li><i class="fas fa-check text-success"></i> ZIP codes</li>
                            <li><i class="fas fa-check text-success"></i> Carriers (FEDEX, UPS, DHL, USPS)</li>
                        </ul>

                        <h6 class="mt-3">Auto-Routing:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Nevada:</strong> Veeqo (UPS/DHL/USPS)</li>
                            <li><strong>California:</strong> Easyship (FedEx)</li>
                        </ul>
                    </div>
                </div>

                <!-- Recent Orders -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6>Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="loadExample()">
                            Load Example Order
                        </button>
                        <a href="/inventory" class="btn btn-sm btn-outline-secondary w-100 mb-2">
                            Manage Inventory
                        </a>
                        <a href="/dashboard" class="btn btn-sm btn-outline-info w-100">
                            View Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js"></script>
    <script>
        let parseTimeout;
        const orderInput = document.getElementById('order_input');
        const previewDiv = document.getElementById('parsing-preview');
        const parsedDataDiv = document.getElementById('parsed-data');
        const confidenceBadge = document.getElementById('confidence-badge');

        // Real-time parsing preview
        orderInput.addEventListener('input', function() {
            clearTimeout(parseTimeout);
            const inputText = this.value.trim();
            
            if (inputText.length > 10) {
                parseTimeout = setTimeout(() => {
                    fetchParsePreview(inputText);
                }, 500);
            } else {
                previewDiv.style.display = 'none';
            }
        });

        function fetchParsePreview(inputText) {
            fetch('/api/parse_preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ input: inputText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.parsed_data) {
                    displayParsedPreview(data.parsed_data, data.confidence);
                }
            })
            .catch(error => {
                console.error('Parsing error:', error);
            });
        }

        function displayParsedPreview(data, confidence) {
            let html = '<div class="row">';
            
            const fields = [
                { key: 'name', label: 'Name', icon: 'user' },
                { key: 'email', label: 'Email', icon: 'envelope' },
                { key: 'phone', label: 'Phone', icon: 'phone' },
                { key: 'address_1', label: 'Address', icon: 'map-marker-alt' },
                { key: 'city', label: 'City', icon: 'city' },
                { key: 'state', label: 'State', icon: 'flag' },
                { key: 'postal_code', label: 'ZIP', icon: 'mail-bulk' },
                { key: 'carrier', label: 'Carrier', icon: 'truck' }
            ];

            fields.forEach(field => {
                const value = data[field.key];
                if (value) {
                    html += `
                        <div class="col-md-6 mb-2">
                            <small class="text-muted"><i class="fas fa-${field.icon}"></i> ${field.label}:</small><br>
                            <strong>${value}</strong>
                        </div>
                    `;
                }
            });

            html += '</div>';
            parsedDataDiv.innerHTML = html;

            // Update confidence badge
            const confidenceColor = confidence >= 80 ? 'success' : confidence >= 60 ? 'warning' : 'danger';
            confidenceBadge.className = `badge confidence-badge bg-${confidenceColor}`;
            confidenceBadge.textContent = `${confidence.toFixed(0)}% confidence`;

            previewDiv.style.display = 'block';
        }

        function loadExample() {
            const exampleOrder = `John Smith
john.smith@email.com
(555) 123-4567
123 Main Street
Las Vegas, NV 89101
UPS`;
            orderInput.value = exampleOrder;
            fetchParsePreview(exampleOrder);
        }

        function clearInput() {
            orderInput.value = '';
            previewDiv.style.display = 'none';
        }

        // Flash messages
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    showAlert('{{ message }}', '{{ category }}');
                {% endfor %}
            {% endif %}
        {% endwith %}

        function showAlert(message, category) {
            const alertClass = category === 'error' ? 'alert-danger' : 'alert-success';
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHtml);
        }
    </script>
</body>
</html>